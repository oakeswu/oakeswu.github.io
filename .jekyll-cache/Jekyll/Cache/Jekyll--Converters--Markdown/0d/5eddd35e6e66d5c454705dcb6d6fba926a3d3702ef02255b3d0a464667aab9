I"ÆX<h1 id="ä»€ä¹ˆæ˜¯classç±»">ä»€ä¹ˆæ˜¯Classç±»</h1>
<p>Classç±»æ˜¯java.langåŒ…ä¸­çš„ç±»ï¼Œæ˜¯javaåå°„ä¸­çš„ä¸€ä¸ªç‰¹åˆ«é‡è¦çš„ç±»ï¼Œå› ä¸ºClassç±»å¯ä»¥è·å–åˆ°ç±»ä¸­çš„æ–¹æ³•ï¼Œå­—æ®µç­‰ä¿¡æ¯ï¼Œç­‰ä¼šçœ‹ä¸‹Classç±»çš„å…·ä½“æºç </p>

<p><img src="/img/doc/reflect/reflect1one.png" alt="ç±»å…³ç³».png" /></p>

<h1 id="classç±»æºç ç²¾ç®€">Classç±»æºç ï¼ˆç²¾ç®€ï¼‰</h1>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>public final class Class&lt;T&gt; implements java.io.Serializable, GenericDeclaration, Type, AnnotatedElement {
    private volatile transient Constructor&lt;T&gt; cachedConstructor;
    private volatile transient Class&lt;?&gt;       newInstanceCallerCache;

    //classçš„æ„é€ å‡½æ•° 
    private Class(ClassLoader loader) {
        // Initialize final field for classLoader.  The initialization value of non-null
        // prevents future JIT optimizations from assuming this final field is null.
        classLoader = loader;
    }
  
    @CallerSensitive
    public static Class&lt;?&gt; forName(String className)  throws ClassNotFoundException {
        Class&lt;?&gt; caller = Reflection.getCallerClass();
        return forName0(className, true, ClassLoader.getClassLoader(caller), caller);
    }

    @CallerSensitive
    public static Class&lt;?&gt; forName(String name, boolean initialize,  ClassLoader loader)
        throws ClassNotFoundException
    {
        Class&lt;?&gt; caller = null;
        SecurityManager sm = System.getSecurityManager();
        if (sm != null) {
            // Reflective call to get caller class is only needed if a security manager
            // is present.  Avoid the overhead of making this call otherwise.
            caller = Reflection.getCallerClass();
            if (sun.misc.VM.isSystemDomainLoader(loader)) {
                ClassLoader ccl = ClassLoader.getClassLoader(caller);
                if (!sun.misc.VM.isSystemDomainLoader(ccl)) {
                    sm.checkPermission(
                        SecurityConstants.GET_CLASSLOADER_PERMISSION);
                }
            }
        }
        return forName0(name, initialize, loader, caller);
    }

    /** Called after security check for system loader access checks have been made. */
    private static native Class&lt;?&gt; forName0(String name, boolean initialize, ClassLoader loader, Class&lt;?&gt; caller) throws ClassNotFoundException;

    @CallerSensitive
    public T newInstance()
        throws InstantiationException, IllegalAccessException
    {
        if (System.getSecurityManager() != null) {
            checkMemberAccess(Member.PUBLIC, Reflection.getCallerClass(), false);
        }

        // NOTE: the following code may not be strictly correct under
        // the current Java memory model.

        // Constructor lookup
        if (cachedConstructor == null) {
            if (this == Class.class) {
                throw new IllegalAccessException(
                    "Can not call newInstance() on the Class for java.lang.Class"
                );
            }
            try {
                Class&lt;?&gt;[] empty = {};
                final Constructor&lt;T&gt; c = getConstructor0(empty, Member.DECLARED);
                // Disable accessibility checks on the constructor
                // since we have to do the security check here anyway
                // (the stack depth is wrong for the Constructor's
                // security check to work)
                java.security.AccessController.doPrivileged(
                    new java.security.PrivilegedAction&lt;Void&gt;() {
                        public Void run() {
                                c.setAccessible(true);
                                return null;
                            }
                        });
                cachedConstructor = c;
            } catch (NoSuchMethodException e) {
                throw (InstantiationException)
                    new InstantiationException(getName()).initCause(e);
            }
        }
        Constructor&lt;T&gt; tmpConstructor = cachedConstructor;
        // Security check (same as in java.lang.reflect.Constructor)
        int modifiers = tmpConstructor.getModifiers();
        if (!Reflection.quickCheckMemberAccess(this, modifiers)) {
            Class&lt;?&gt; caller = Reflection.getCallerClass();
            if (newInstanceCallerCache != caller) {
                Reflection.ensureMemberAccess(caller, this, null, modifiers);
                newInstanceCallerCache = caller;
            }
        }
        // Run constructor
        try {
            return tmpConstructor.newInstance((Object[])null);
        } catch (InvocationTargetException e) {
            Unsafe.getUnsafe().throwException(e.getTargetException());
            // Not reached
            return null;
        }
    }
    
    // å…¥å‚æ˜¯å¦æ˜¯å½“å‰ç±»çš„å¯¹è±¡
    public native boolean isInstance(Object obj);
    // å…¥å‚æ˜¯å¦æ˜¯å½“å‰ç±»çš„è¶…ç±»æˆ–ç›¸åŒç±»
    public native boolean isAssignableFrom(Class&lt;?&gt; cls);
    //å½“å‰ç±»æ˜¯å¦æ˜¯æ¥å£
    public native boolean isInterface();
    //å½“å‰ç±»æ˜¯å¦æ˜¯æ•°ç»„
    public native boolean isArray();
    //å½“å‰ç±»æ˜¯å¦æ˜¯åŸºæœ¬æ•°æ®ç±»å‹
    public native boolean isPrimitive();
    //å½“å‰ç±»æ˜¯å¦æ˜¯æ³¨è§£
    public boolean isAnnotation() {
        return (getModifiers() &amp; ANNOTATION) != 0;
    }
    //å½“å‰ç±»æ˜¯å¦jvmè‡ªå·±ç”Ÿæˆç±»
    public boolean isSynthetic() {
        return (getModifiers() &amp; SYNTHETIC) != 0;
    }
    //è·å–å½“å‰ç±»çš„ç±»åŠ è½½å™¨
    @CallerSensitive
    public ClassLoader getClassLoader() {
        ClassLoader cl = getClassLoader0();
        if (cl == null)
            return null;
        SecurityManager sm = System.getSecurityManager();
        if (sm != null) {
            ClassLoader.checkClassLoaderPermission(cl, Reflection.getCallerClass());
        }
        return cl;
    }
    // Package-private to allow ClassLoader access
    ClassLoader getClassLoader0() { return classLoader; }
    // Initialized in JVM not by private constructo
    private final ClassLoader classLoader;

    //è¿”å›æ³›å‹ç±»ä¸­çš„æ³›å‹å‚æ•°æ•°ç»„
    public TypeVariable&lt;Class&lt;T&gt;&gt;[] getTypeParameters() {
        ClassRepository info = getGenericInfo();
        if (info != null)
            return (TypeVariable&lt;Class&lt;T&gt;&gt;[])info.getTypeParameters();
        else
            return (TypeVariable&lt;Class&lt;T&gt;&gt;[])new TypeVariable&lt;?&gt;[0];
    }

    //è·å–å½“å‰ç±»çš„è¶…ç±»
    public native Class&lt;? super T&gt; getSuperclass();
    //è·å–å½“å‰ç±»çš„ç›´æ¥è¶…ç±»
    public Type getGenericSuperclass() {
        ClassRepository info = getGenericInfo();
        if (info == null) {
            return getSuperclass();
        }

        // Historical irregularity:
        // Generic signature marks interfaces with superclass = Object
        // but this API returns null for interfaces
        if (isInterface()) {
            return null;
        }

        return info.getSuperclass();
    }

    //è·å–å½“å‰ç±»å®ç°çš„æ¥å£æ•°ç»„
    public Class&lt;?&gt;[] getInterfaces() {
        ReflectionData&lt;T&gt; rd = reflectionData();
        if (rd == null) {
            // no cloning required
            return getInterfaces0();
        } else {
            Class&lt;?&gt;[] interfaces = rd.interfaces;
            if (interfaces == null) {
                interfaces = getInterfaces0();
                rd.interfaces = interfaces;
            }
            // defensively copy before handing over to user code
            return interfaces.clone();
        }
    }

    private native Class&lt;?&gt;[] getInterfaces0();
    //è·å–å½“å‰ç±»ç›´æ¥å®ç°çš„æ¥å£æ•°ç»„
    public Type[] getGenericInterfaces() {
        ClassRepository info = getGenericInfo();
        return (info == null) ?  getInterfaces() : info.getSuperInterfaces();
    }

    //è·å–å½“å‰æ•°ç»„çš„å…ƒç´ ç±»å‹
    public native Class&lt;?&gt; getComponentType();
    //è·å–å½“å‰ç±»çš„ä¿®é¥°ç¬¦
    public native int getModifiers();
    //è·å–å½“å‰ç±»çš„ç­¾å
    public native Object[] getSigners();
    
    //è·å–å½“å‰ç±»çš„ç±»å
    public String getSimpleName() {
        if (isArray())
            return getComponentType().getSimpleName()+"[]";

        String simpleName = getSimpleBinaryName();
        if (simpleName == null) { // top level class
            simpleName = getName();
            return simpleName.substring(simpleName.lastIndexOf(".")+1); // strip the package name
        }
        int length = simpleName.length();
        if (length &lt; 1 || simpleName.charAt(0) != '$')
            throw new InternalError("Malformed class name");
        int index = 1;
        while (index &lt; length &amp;&amp; isAsciiDigit(simpleName.charAt(index)))
            index++;
        return simpleName.substring(index);
    }

    //è·å–å½“å‰publicä¿®é¥°çš„å†…éƒ¨ç±»å’Œæ¥å£
    public Class&lt;?&gt;[] getClasses() {
        checkMemberAccess(Member.PUBLIC, Reflection.getCallerClass(), false);
        return java.security.AccessController.doPrivileged(
            new java.security.PrivilegedAction&lt;Class&lt;?&gt;[]&gt;() {
                public Class&lt;?&gt;[] run() {
                    List&lt;Class&lt;?&gt;&gt; list = new ArrayList&lt;&gt;();
                    Class&lt;?&gt; currentClass = Class.this;
                    while (currentClass != null) {
                        Class&lt;?&gt;[] members = currentClass.getDeclaredClasses();
                        for (int i = 0; i &lt; members.length; i++) {
                            if (Modifier.isPublic(members[i].getModifiers())) {
                                list.add(members[i]);
                            }
                        }
                        currentClass = currentClass.getSuperclass();
                    }
                    return list.toArray(new Class&lt;?&gt;[0]);
                }
            });
    }
    //è·å–å½“å‰ç±»æ‰€æœ‰å†…éƒ¨ç±»å’Œæ¥å£ï¼Œä¸è¿‡æ’é™¤ç›´æ¥ç»§æ‰¿
    public Class&lt;?&gt;[] getDeclaredClasses() throws SecurityException {
        checkMemberAccess(Member.DECLARED, Reflection.getCallerClass(), false);
        return getDeclaredClasses0();
    }

    //è·å–å½“å‰ç±»ä¸­publicä¿®é¥°çš„å­—æ®µ
    public Field[] getFields() throws SecurityException {
        checkMemberAccess(Member.PUBLIC, Reflection.getCallerClass(), true);
        return copyFields(privateGetPublicFields(null));
    }
    //è·å–æŒ‡å®šåç§°çš„æ–¹æ³•
    public Field getField(String name)
        throws NoSuchFieldException, SecurityException {
        checkMemberAccess(Member.PUBLIC, Reflection.getCallerClass(), true);
        Field field = getField0(name);
        if (field == null) {
            throw new NoSuchFieldException(name);
        }
        return field;
    }
    //è·å–æ‰€æœ‰å£°æ˜çš„å­—æ®µ
    public Field[] getDeclaredFields() throws SecurityException {
        checkMemberAccess(Member.DECLARED, Reflection.getCallerClass(), true);
        return copyFields(privateGetDeclaredFields(false));
    }

    //è·å–publicä¿®é¥°çš„æ–¹æ³•
    public Method[] getMethods() throws SecurityException {
        checkMemberAccess(Member.PUBLIC, Reflection.getCallerClass(), true);
        return copyMethods(privateGetPublicMethods());
    }
    //è·å–æŒ‡å®šä¼ å‚ç±»å‹å’Œåç§°çš„æ–¹æ³•
    public Method getMethod(String name, Class&lt;?&gt;... parameterTypes)
        throws NoSuchMethodException, SecurityException {
        checkMemberAccess(Member.PUBLIC, Reflection.getCallerClass(), true);
        Method method = getMethod0(name, parameterTypes, true);
        if (method == null) {
            throw new NoSuchMethodException(getName() + "." + name + argumentTypesToString(parameterTypes));
        }
        return method;
    }
    //è·å–æ‰€æœ‰å£°æ˜çš„ç±»
    public Class&lt;?&gt;[] getDeclaredClasses() throws SecurityException {
        checkMemberAccess(Member.DECLARED, Reflection.getCallerClass(), false);
        return getDeclaredClasses0();
    }
  
    //è·å–publicä¿®é¥°çš„æ„é€ å™¨
    public Constructor&lt;?&gt;[] getConstructors() throws SecurityException {
        checkMemberAccess(Member.PUBLIC, Reflection.getCallerClass(), true);
        return copyConstructors(privateGetDeclaredConstructors(true));
    }
    //è·å–ä¼ å‚çš„æ„é€ å™¨
    public Constructor&lt;T&gt; getConstructor(Class&lt;?&gt;... parameterTypes)
        throws NoSuchMethodException, SecurityException {
        checkMemberAccess(Member.PUBLIC, Reflection.getCallerClass(), true);
        return getConstructor0(parameterTypes, Member.PUBLIC);
    }
    //è·å–æ‰€æœ‰å£°æ˜çš„æ„é€ å™¨
    public Constructor&lt;?&gt;[] getDeclaredConstructors() throws SecurityException {
        checkMemberAccess(Member.DECLARED, Reflection.getCallerClass(), true);
        return copyConstructors(privateGetDeclaredConstructors(false));
    }
}
</code></pre></div></div>
<h1 id="ä¾‹å­">ä¾‹å­</h1>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">reflect</span><span class="p">;</span>

<span class="k">public</span> <span class="n">class</span> <span class="n">EmployeeDto</span> <span class="p">{</span>
    <span class="n">private</span> <span class="n">int</span> <span class="n">age</span><span class="p">;</span>
    <span class="n">private</span> <span class="k">String</span> <span class="n">name</span><span class="p">;</span>

    <span class="n">EmployeeDto</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">this</span><span class="p">.</span><span class="n">age</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>
        <span class="n">this</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="s2">"default"</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">EmployeeDto</span><span class="p">(</span><span class="n">int</span> <span class="n">age</span><span class="p">,</span> <span class="k">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">this</span><span class="p">.</span><span class="n">age</span> <span class="p">=</span> <span class="n">age</span><span class="p">;</span>
        <span class="n">this</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">int</span> <span class="n">getAge</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">return</span> <span class="n">age</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">void</span> <span class="n">setAge</span><span class="p">(</span><span class="n">int</span> <span class="n">age</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">this</span><span class="p">.</span><span class="n">age</span> <span class="p">=</span> <span class="n">age</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">String</span> <span class="n">getName</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">return</span> <span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">void</span> <span class="n">setName</span><span class="p">(</span><span class="k">String</span> <span class="n">name</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">this</span><span class="p">.</span><span class="n">name</span> <span class="p">=</span> <span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">boolean</span> <span class="n">isOlder</span><span class="p">(</span><span class="n">int</span> <span class="n">tmpAge</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">return</span> <span class="n">age</span> <span class="p">&gt;</span> <span class="n">tmpAge</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="p">@</span><span class="n">Override</span>
    <span class="k">public</span> <span class="k">String</span> <span class="n">toString</span><span class="p">()</span> <span class="p">{</span>
        <span class="n">return</span> <span class="s2">"age:"</span> <span class="p">+</span> <span class="n">age</span> <span class="p">+</span> <span class="s2">",name:"</span> <span class="p">+</span> <span class="n">name</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">reflect</span><span class="p">;</span>

<span class="n">import</span> <span class="n">java</span><span class="p">.</span><span class="n">lang</span><span class="p">.</span><span class="n">reflect</span><span class="p">.</span><span class="n">Field</span><span class="p">;</span>
<span class="n">import</span> <span class="n">java</span><span class="p">.</span><span class="n">lang</span><span class="p">.</span><span class="n">reflect</span><span class="p">.</span><span class="n">Method</span><span class="p">;</span>

<span class="k">public</span> <span class="n">class</span> <span class="n">EmployeeDtoReflect</span> <span class="p">{</span>

    <span class="k">public</span> <span class="n">void</span> <span class="n">test</span><span class="p">(</span><span class="n">Class</span><span class="p">&lt;?&gt;</span> <span class="n">clazz</span><span class="p">)</span> <span class="n">throws</span> <span class="n">Exception</span><span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">clazz</span><span class="p">.</span><span class="n">isInstance</span><span class="p">(</span><span class="n">new</span> <span class="n">EmployeeDto</span><span class="p">()))</span> <span class="p">{</span>
            <span class="n">EmployeeDto</span> <span class="n">employee</span> <span class="p">=</span> <span class="p">(</span><span class="n">EmployeeDto</span><span class="p">)</span> <span class="n">clazz</span><span class="p">.</span><span class="n">newInstance</span><span class="p">();</span>
            <span class="nf">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s2">"EmployeeDeo:"</span> <span class="p">+</span> <span class="n">employee</span><span class="p">);</span>
            <span class="n">Method</span><span class="p">[]</span> <span class="n">methods</span> <span class="p">=</span> <span class="n">clazz</span><span class="p">.</span><span class="n">getDeclaredMethods</span><span class="p">();</span>
            <span class="n">for</span><span class="p">(</span><span class="n">Method</span> <span class="n">method</span> <span class="p">:</span> <span class="n">methods</span><span class="p">)</span> <span class="p">{</span>
                <span class="nf">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s2">"Method:"</span> <span class="p">+</span> <span class="n">method</span><span class="p">.</span><span class="n">getName</span><span class="p">());</span>
            <span class="p">}</span>
            <span class="n">Field</span><span class="p">[]</span> <span class="n">fileds</span> <span class="p">=</span> <span class="n">clazz</span><span class="p">.</span><span class="n">getDeclaredFields</span><span class="p">();</span>
            <span class="n">for</span> <span class="p">(</span><span class="n">Field</span> <span class="n">field</span> <span class="p">:</span> <span class="n">fileds</span><span class="p">)</span> <span class="p">{</span>
                <span class="nf">System</span><span class="p">.</span><span class="n">out</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s2">"Fields:"</span> <span class="p">+</span> <span class="n">field</span><span class="p">.</span><span class="n">getName</span><span class="p">());</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="n">static</span> <span class="n">void</span> <span class="n">main</span><span class="p">(</span><span class="k">String</span><span class="p">[]</span> <span class="n">args</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">try</span> <span class="p">{</span>
            <span class="n">new</span> <span class="n">EmployeeDtoReflect</span><span class="p">().</span><span class="n">test</span><span class="p">(</span><span class="n">EmployeeDto</span><span class="p">.</span><span class="n">class</span><span class="p">);</span>
        <span class="p">}</span> <span class="n">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">e</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">e</span><span class="p">.</span><span class="n">printStackTrace</span><span class="p">();</span>
        <span class="p">}</span>

    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>
<p>æˆ‘ä»¬å¯ä»¥çœ‹ä¸‹æ‰§è¡Œç»“æœ</p>
<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Connected to the target VM, address: '127.0.0.1:54290', transport: 'socket'
Disconnected from the target VM, address: '127.0.0.1:54290', transport: 'socket'
EmployeeDeo:age:0,name:default
Method:toString
Method:getName
Method:setName
Method:setAge
Method:isOlder
Method:getAge
Fields:age
Fields:name

Process finished with exit code 0
</code></pre></div></div>
<h1 id="æ€»ç»“">æ€»ç»“</h1>
<ul>
  <li>ä¸Šé¢æµ‹è¯•ä»£ç åªæµ‹è¯•äº†newInstance()æ–¹æ³•ï¼ŒgetDeclaredMethods()å’ŒgetDeclaredFields()æ–¹æ³•. æµ‹è¯•ä»£ç é€šè¿‡ç±».classè·å–Classç±»ï¼Œæˆ‘ä»¬ä¹Ÿé˜”ä»¥é€šè¿‡Class.forName(â€œç±»è·¯å¾„â€)è·å–ï¼Œè¿™ä¸ªåœ¨è·å–å…·ä½“æ•°æ®åº“é©±åŠ¨æ—¶å¸¸ç”¨åˆ°ã€‚</li>
  <li>Classç±»æ˜¯Javaåå°„ä¸­åŸºç¡€çš„ä¸€ä¸ªç±»ï¼Œå› ä¸ºå®ƒèƒ½è·å–åˆ°ä¸€ä¸ªç±»ä¸­çš„å˜é‡ï¼Œæ–¹æ³•ï¼Œæ„é€ å‡½æ•°ç­‰ï¼Œåƒspringç­‰å¼€æºæ¡†æ¶ä¸­å¤§é‡ä½¿ç”¨äº†åå°„ï¼Œä½†æ˜¯åå°„çš„æ•ˆç‡ä¸€èˆ¬ï¼Œå¹¶ä¸”æœ‰å¯èƒ½ç ´åjavaä¸­è®¿é—®ä¿®é¥°ç¬¦çš„è®¿é—®æƒé™æ§åˆ¶</li>
</ul>
:ET